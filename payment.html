<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Your Purchase</title>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
</head>

<body class="payment-page">
  <header class="text-center">
    <div class="instagram-link">
      <a href="https://ig.me/m/eventsbynbn" target="_blank">Click and Message Us on Instagram</a>
    </div>

    <img src="logo-placeholder.png" alt="North by Nature Logo" class="logo" />

    <nav>
      <ul class="nav justify-content-center">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="members.html">Members</a></li>
        <li class="nav-item"><a class="nav-link" href="partnerships.html">Partnerships and Collaborations</a></li>
        <li class="nav-item"><a class="nav-link" href="exclusive.html">Exclusive</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Gallery</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
      </ul>
    </nav>

    <div class="cart-icon">
      <a href="cart.html">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count">0</span>
      </a>
    </div>
  </header>

  <main class="container main-content">
    <h2>Complete Your Purchase</h2>

    <!-- Order summary -->
    <div id="summary" class="mb-3"></div>

    <!-- Pay button -->
    <button id="pay-btn" class="btn btn-primary">Pay securely</button>
    <p id="pay-msg" class="mt-2"></p>
  </main>

  <footer class="instagram-footer">
    <div class="footer-container">
      <div class="footer-links">
        <h4>Policies</h4>
        <ul>
          <li><a href="privacy.html">Privacy Policy</a></li>
          <li><a href="terms.html">Terms of Service</a></li>
        </ul>
      </div>
      <div class="footer-center">
        <p>
          Follow us on
          <a href="https://www.instagram.com/eventsbynbn/" target="_blank" class="instagram-link">@eventsbynbn</a>
        </p>
        <iframe
          src="https://snapwidget.com/embed/1098891"
          class="snapwidget-widget"
          allowtransparency="true"
          frameborder="0"
          scrolling="no"
          style="border:none; overflow:hidden; width:480px; height:160px"
          title="Posts from Instagram">
        </iframe>
        <p>&copy; 2024 North by Nature. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- JS (kept at end for performance) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
  <!-- fixed URL: stackpath.bootstrapcdn.com -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- Your global script bundle -->
  <script src="scripts.js"></script>

  <!-- Page-specific script to handle Stripe Checkout -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Update cart icon if your scripts.js exposes updateCartCount()
      if (typeof updateCartCount === 'function') updateCartCount();

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const summary = document.getElementById('summary');
      const payBtn = document.getElementById('pay-btn');
      const payMsg = document.getElementById('pay-msg');

      if (!cart.length) {
        summary.innerHTML = '<p>Your cart is empty.</p>';
        payBtn.disabled = true;
        return;
      }

      const rows = cart.map(i => {
        const qty = Number(i.quantity || 0);
        const lineTotal = (Number(i.price || 0) * qty).toFixed(2);
        return `
          <div class="d-flex justify-content-between align-items-center py-1">
            <div>
              <strong>${i.eventTitle}</strong>
              <div class="text-muted small">${i.ticketType} × ${qty}</div>
            </div>
            <div>£${lineTotal}</div>
          </div>
        `;
      }).join('');

      const total = cart.reduce((s, i) => s + (Number(i.price || 0) * Number(i.quantity || 0)), 0);
      summary.innerHTML = `
        <div class="card p-3">
          ${rows}
          <hr/>
          <div class="d-flex justify-content-between">
            <strong>Total</strong>
            <strong>£${total.toFixed(2)}</strong>
          </div>
        </div>
      `;

      // Initialise Stripe (replace with your real publishable key)
      const stripe = Stripe('pk_live_YOUR_PUBLISHABLE_KEY');

      payBtn.addEventListener('click', async () => {
        payBtn.disabled = true;
        payMsg.textContent = 'Creating secure checkout…';

        try {
          const res = await fetch('/.netlify/functions/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cart })
          });

          const data = await res.json();
          if (data.error) throw new Error(data.error);

          const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
          if (error) throw error;
        } catch (err) {
          payMsg.textContent = err.message || 'Payment error.';
          payBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
